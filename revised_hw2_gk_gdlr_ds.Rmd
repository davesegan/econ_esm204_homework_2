---
title: "econ_hw2_clean"
author: "David Segan, Gavi Keyles, Gabe De La Rosa"
date: "4/26/2020"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r, include = FALSE}
# Load libraries and bring in data
library(tidyverse)
library(janitor)
library(stargazer)
mc_sector <- readxl::read_xlsx("HW2_Data.xlsx") %>% 
  clean_names()
```

```{r}
# Linear models of marginal abatement costs by sector
lm_sector_a <- lm(mc_a ~ abatement, data = mc_sector)
lm_sector_b <- lm(mc_b ~ abatement, data = mc_sector)
lm_sector_c <- lm(mc_c ~ abatement, data = mc_sector)
lm_sector_d <- lm(mc_d ~ abatement, data = mc_sector)

# Naming coefficients and current emission levels
# coeff = abatement coefficient (slope of MAC curve)
# const = constant (intercept of MAC curve)

a_coeff <- lm_sector_a$coefficients[2]
a_const <- lm_sector_a$coefficients[1]
b_coeff <- lm_sector_b$coefficients[2]
b_const <- lm_sector_b$coefficients[1]
c_coeff <- lm_sector_c$coefficients[2]
c_const <- lm_sector_c$coefficients[1]
d_coeff <- lm_sector_d$coefficients[2]
d_const <- lm_sector_d$coefficients[1]

# Current emissions
a_emissions_current <- 170
b_emissions_current <- 200
c_emissions_current <- 230
d_emissions_current <- 300

# Supply curves for price (marginal abatement costs)
a_supply <- function(abatement) {a_coeff*abatement + a_const}
b_supply <- function(abatement) {b_coeff*abatement + b_const}
c_supply <- function(abatement) {c_coeff*abatement + c_const}
d_supply <- function(abatement) {d_coeff*abatement + d_const}

# Supply curves for Abatement

a_abatement <- function(a_supply){(a_supply - a_const)/a_coeff}
b_abatement <- function(b_supply){(b_supply - b_const)/b_coeff}
c_abatement <- function(c_supply){(c_supply - c_const)/c_coeff}
d_abatement <- function(d_supply){(d_supply - d_const)/d_coeff}

# Demand curves for price (marginal benefit of each additional ton of pollution)

a_price <- function(pollution) {a_coeff*(a_emissions_current - pollution) + a_const}
b_price <- function(pollution) {b_coeff*(b_emissions_current - pollution) + b_const}
c_price <- function(pollution) {c_coeff*(c_emissions_current - pollution) + c_const}
d_price <- function(pollution) {d_coeff*(d_emissions_current - pollution) + d_const}

# Demand curves for emissions

a_pollution <- function(a_price) {a_emissions_current - ((a_price - a_const)/a_coeff)}
b_pollution <- function(b_price) {b_emissions_current - ((b_price - b_const)/b_coeff)}
c_pollution <- function(c_price) {c_emissions_current - ((c_price - c_const)/c_coeff)}
d_pollution <- function(d_price) {d_emissions_current - ((d_price - d_const)/d_coeff)}
```

View Linear Models

```{r}
lm_sector_a
lm_sector_b
lm_sector_c
lm_sector_d
```


### Question 1

Marginal Cost of Abatement = (m)*Abatement + (b)

##### Sector A
```{r}
# -----------------
# Sector A - linear model overlayed with MC curve
# -----------------

sector_a <- mc_sector %>% 
  select(abatement, mc_a)
predict_df_a <- predict(lm_sector_a, sector_a)
df_a <- data.frame(sector_a, predict_df_a)
ggplot() +
  geom_line(data = lm_sector_a,
             aes(x = abatement,
                 y = mc_a),
             color = "darkgreen",
             size = 1, 
             alpha = 1) +
  geom_line(data = df_a,
            aes(x = abatement,
                y = predict_df_a)) +
  theme_light() +
  labs(title = "Sector A predicted marginal cost of abatement by abatement levels",
       x = "Abatement (Tons)",
       y = "Marginal Cost")
```

```{r, results = "asis"}
# -----------
# Sector A - Linear model stats
# -----------
stargazer(lm_sector_a, type = "html")
```

##### Sector B
```{r B LM and MC}
# -----------
# Sector B - linear model overlayed with MC curve
# -----------
sector_b <- mc_sector %>% # Select data
  select(abatement, mc_b) 
predict_df_b <- mc_sector %>% # predict it back to the original data frame
  mutate(pred_b = predict(lm_sector_b, mc_sector))
df_b <- data.frame(sector_b, predict_df_b) # data frame with both actual mc and predicted
ggplot(data = predict_df_b) + # And plot it
  geom_line(aes(x = abatement, y = mc_b),
            color = "lightsteelblue3",
            size = 1, 
            alpha = 1) +
  geom_line(aes(x = abatement, y = pred_b)) +
  theme_light() +
  labs(title = "Sector B predicted marginal cost of abatement by abatement levels",
       x = "Abatement (Tons)",
       y = "Marginal Cost")
  
```

```{r B stargazer, results = "asis"}
# -----------
# Sector B - Linear model stats
# -----------
stargazer(lm_sector_b, type = "html")
```

##### Sector C
```{r}
# -----------------
# Sector C - linear model overlayed with MC curve
# -----------------
sector_c <- mc_sector %>%
  select(abatement, mc_c) 
predict_df_c <- predict(lm_sector_c, sector_c)
df_c <- data.frame(sector_c, predict_df_c)
ggplot() +
  geom_line(data = lm_sector_c,
             aes(x = abatement,
                 y = mc_c),
             color = "red",
             size = 1,
             alpha = 1) +
  geom_line(data = df_c,
            aes(x = abatement,
                y = predict_df_c)) +
  theme_light() +
  labs(title = "Sector C predicted marginal cost of abatement by abatement levels",
       x = "Abatement (Tons)",
       y = "Marginal Cost")
```

```{r, results = "asis"}
# -----------
# Sector C - Linear model stats
# -----------
stargazer(lm_sector_c, type = "html")
```
##### Sector D
```{r}
# -----------------
# Sector D - linear model overlayed with MC curve
# -----------------
sector_d <- mc_sector %>% 
  select(abatement, mc_d)
predict_df_d <- predict(lm_sector_d, sector_d)
df_d <- data.frame(sector_d, predict_df_d)
ggplot() +
  geom_line(data = lm_sector_d,
             aes(x = abatement,
                 y = mc_d),
             color = "coral",
             size = 1, 
             alpha = 1) +
  geom_line(data = df_d,
            aes(x = abatement,
                y = predict_df_d)) +
  theme_light() +
  labs(title = "Sector D predicted marginal cost of abatement by abatement levels",
       x = "Abatement (Tons)",
       y = "Marginal Cost")
```

```{r, results = "asis"}
# -----------
# Sector D - Model stats
# -----------
stargazer(lm_sector_d, type = "html")
```

```{r all sectors marginal abatement costs}
# -----------
# All sectors - Marginal abatement costs
# -----------
ggplot() +
  geom_line(data = df_a,
            aes(x = abatement,
                y = predict_df_a),
            color = "darkgreen",
            size = 1,
            alpha = 1) +
  geom_line(data = df_b,
            aes(x = abatement, y = pred_b),
            color = "lightsteelblue3",
            size = 1,
            alpha = 1) +
  geom_line(data = df_c,
            aes(x = abatement,
                y = predict_df_c),
            color = "red",
            size = 1, 
            alpha = 1) +
  geom_line(data = df_d,
            aes(x = abatement,
                y = predict_df_d),
            color = "coral",
             size = 1, 
             alpha = 1) +
  theme_light() +
  labs(title = "All sectors predicted marginal cost of abatement by abatement levels",
       x = "Abatement (Tons)",
       y = "Marginal Cost ($/ton)")
```

### Question 2
##### Demand for emissions
```{r full demand curve}
# -----------
# All sectors - demand curve
# -----------
q_pollution <- seq(0,300, by = 10) # Make a list of pollution values
full_demand_df <- data.frame(q_pollution) # Add it into a df
full_demand_df <- full_demand_df %>% # Calculate each sector's price..
  mutate(a_price = a_price(q_pollution)) %>% 
  mutate(b_price = b_price(q_pollution)) %>% 
  mutate(c_price = c_price(q_pollution)) %>% 
  mutate(d_price = d_price(q_pollution))

# Repeat for prices:

p_pollution <- seq(0,300, by = 10) # Make a list of prices
full_demand_p_df <- data.frame(p_pollution) # Add it into a df

full_demand_p_df <- full_demand_p_df %>% # Calculate each sector's price..
  mutate(a_pollution = a_pollution(p_pollution)) %>% 
  mutate(b_pollution = b_pollution(p_pollution)) %>%
  mutate(c_pollution = c_pollution(p_pollution)) %>% 
  mutate(d_pollution = d_pollution(p_pollution)) %>% 
  mutate(total_pollution = a_pollution + b_pollution + c_pollution + d_pollution)

ggplot(data = full_demand_p_df, aes(y = p_pollution)) + # graph it
  geom_line(aes(x = a_pollution),
            color = "darkgreen") +
  geom_line(aes(x = b_pollution),
            color = "lightsteelblue3") +
  geom_line(aes(x = c_pollution),
            color = "red") +
  geom_line(aes(x = d_pollution),
            color = "coral") # +
  # geom_line(aes(x = total_pollution),
  #          color = "black") +
  scale_x_continuous(limits = c(0, 1000),
                     expand = c(0,0))

```

### Question 3
##### Policy options
For each policy:
(1) the total cost of meeting the target in country X,
(2) the cost (or benefit) to each sector
(3) the tax revenue generated.

```{r abatement functions and graph}
## --------
## Full abatement curve
## --------
price_abatement <- seq(0,300, by = 10) # Make a list of prices
full_abatement_p_df <- data.frame(price_abatement) # Add it into a df

full_abatement_p_df <- full_demand_p_df %>% # Calculate each sector's price..
  mutate(a_abatement = a_abatement(price_abatement)) %>% 
  mutate(b_abatement = b_abatement(price_abatement)) %>%
  mutate(c_abatement = c_abatement(price_abatement)) %>% 
  mutate(d_abatement = d_abatement(price_abatement)) %>% 
  mutate(total_abatement = a_abatement + b_abatement + c_abatement + d_abatement)

ggplot(data = full_abatement_p_df, aes(y = price_abatement)) + # graph it
  geom_line(aes(x = a_abatement),
            color = "darkgreen") +
  geom_line(aes(x = b_abatement),
            color = "lightsteelblue3") +
  geom_line(aes(x = c_abatement),
            color = "red") +
  geom_line(aes(x = d_abatement),
            color = "coral") +
  geom_line(aes(x = total_abatement),
           color = "black") +
  scale_x_continuous(limits = c(0, 1000),
                     expand = c(0,0))
```

```{r total abatement quantity and price functions}
## --------
## Aggregate abatement model
## --------
lm_total_abatement <- lm(total_abatement ~ price_abatement, data = full_abatement_p_df) # LM of the total line
total_abatement_coeff <- lm_total_abatement$coefficients[2]
total_abatement_const <- lm_total_abatement$coefficients[1]
total_abatement_fx <- function(price_abatement){total_abatement_coeff * price + total_abatement_const} # Function from the LM
```

##### a. Cap on carbon
##### (1) total cost of meeting the target in country X
```{r 300 ton cap on carbon}
##---------
## Total cost to country X:
##---------
a_cap_cost <- integrate(a_supply, lower = 0, upper = 100) # First, we calculate cost to each sector
b_cap_cost <- integrate(b_supply, lower = 0, upper = 100)
c_cap_cost <- integrate(c_supply, lower = 0, upper = 100)
X_cap_cost <- a_cap_cost$value[1] + b_cap_cost$value[1] + c_cap_cost$value[1] # Then add them
X_cap_cost
```
##### (2) cost to each sector:
```{r}
# See above
a_cap_cost$value[1]
b_cap_cost$value[1]
c_cap_cost$value[1]
```

##### (3) tax revenue generated:
```{r}
# Zero!
```

##### b. Tax on carbon
```{r}
# What tax accomplishes desired reduction of 300 tons

# We can easily calculate the cost per ton of 300 tons of abatement using our total abatement function...
tot_abate_p_fx(300)
# sum total is 54.8341 $/ton. 

tot_abate_p_fx(0)
# The intercept is at zero is -2.6369....does this matter? No, because there is currently zero tax. 

```

##### (1) total cost of meeting this target to country x:

```{r}

### This is super incomplete and maybe the wrong start (from Gabe)

# First, we need to find out how much each firm abates when the aggregate abatement is 300:

a_abatement_fx(tot_abate_p_fx(300))

b_abatement_fx(tot_abate_p_fx(300))

c_abatement_fx(tot_abate_p_fx(300))


# To double check...
a_abatement_fx(tot_abate_p_fx(300)) + b_abatement_fx(tot_abate_p_fx(300)) + c_abatement_fx(tot_abate_p_fx(300))
```


##### (2) cost to each sector:



##### (3) tax revenue generated:

```{r}
#To get the tax, we calculate the square with one side that's the tax (old marginal cost curve - new MCC = tax (we don't change slopes...)), and the other with the new amount of carbon produced (600 - 300 = 300)

# We multiply this by 300 tons...
tot_abate_p_fx(300) * 300

# so the tax revenue is $16,452.93
```



##### c. Cap and trade

First, let's make an aggregate demand for all of these...

```{r}
# This is a vertical sum, not great
demand_agg <- seq(0, 250, by = 10)
agg_demand_df <- data.frame(demand_agg)
agg_demand_df <- agg_demand_df %>% 
  mutate(a_p = a_price(demand_agg)) %>% 
  mutate(b_p = b_price(demand_agg)) %>% 
  mutate(c_p = c_demand(demand_agg)) %>% 
  mutate(total_p = a_p + b_p + c_p)

# Let's make a horizontal sum...

# We needa flip our functions
view(a_price)

a_q_demand <- function(price){
  ((price + a_const)/a_coeff)+a_emissions_current
}

b_q_demand <- function(price) {
 ((price + b_const)/b_coeff)+b_emissions_current
}

c_q_demand <- function(price) {
  ((price + c_const)/c_coeff)+c_emissions_current
}

price <- seq(0, 300, by = 10)
demand_q_pred_df <- data.frame(price)
demand_q_pred_df <- q_pred_df %>% 
  mutate(p_a = a_q_demand(price)) %>% 
  mutate(p_b = b_q_demand(price)) %>% 
  mutate(p_c = c_q_demand(price)) %>% 
  mutate(total_demand = p_a + p_b + p_c)

## Graph the aggregate demand curve...

ggplot(demand_q_pred_df, aes(y = price)) +
  geom_line(aes(x = p_a),
            color = "red") +
  geom_line(aes(x = p_b), 
            color = "green") +
  geom_line(aes(x = p_c),
            color = "blue") +
  geom_line(aes(x = total_demand))

# graph this to double check its a vertical sum...

# ggplot(agg_demand_df, aes(x = demand_agg)) +
#   geom_line(aes(y = a_p),
#             color = "red") +
#   geom_line(aes(y = b_p), 
#             color = "green") +
#   geom_line(aes(y = c_p),
#             color = "blue") +
#   geom_line(aes(y = horizontal_agg_demand))
```
Then, we can pull the price and quantity models from this...

```{r}

# Price, given a quantity
agg_demand_p <- lm(total_p ~ demand_agg , data = agg_demand_df)
agg_demand_p

agg_demand_p_fx <- function(quantity){
  -2.295 * quantity + 440.984
}

#Quantity, given a price
agg_demand_q <- lm(demand_agg ~ total_p, data = agg_demand_df)
agg_demand_q

agg_demand_q_fx <- function(price){
  -0.4357 * price + 192.1499
}
```



```{r}
# Outcome of trading if each sector gets 100 carbon credits
# Now that we have the aggregate curve, we can use what Costello taught us in class to get the price at which 300 units of abatement occurs, and then plug our p back into our 3 individual curves to get the results.
# First, plug in abatement (300) into aggregate curve function
permit_trading_price <- tot_abate_fx_p_gavi(300)
# Just checking we did this the same way...yes!
permit_trading_price_gabe <- tot_abate_p_fx(300)
# Now, plug into individual abatement functions      
permits_traded_a <- a_abatement_fx(permit_trading_price)
permits_traded_b <- b_abatement_fx(permit_trading_price)
permits_traded_c <- c_abatement_fx(permit_trading_price)
# Let's check that they add up to 300
permits_traded_a + permits_traded_b + permits_traded_c
# Rounding error, but pretty close!
```

### Question 4
##### Should country X (sector D) join a carbon cap and trade market in country Y?

```{r}
# Country Y:
# current emissions: 300 tons per year

# Basically, we need to add sector D to the abatement graph then calculate a new aggregate cost curve

lm_sector_d

# Predicts the price...
sector_d_cost_fx <- function(abatement){
  0.5533 * abatement - 12.1969
}

# Predicts the quantity...
sector_d_q_fx <- function(price){
  (price + 12.1969) / 0.5533
}

# Add them together in a df, then make an aggregate quantity column...
agg_abate_d_df <-  q_pred_df %>% 
  mutate(q_d = sector_d_q_fx(price)) %>% 
  mutate(q_agg = q_a + q_b + q_c + q_d)


ggplot(agg_abate_d_df, aes(y = price)) +
  geom_line(aes(x = q_a),
            color = "red") +
  geom_line(aes(x = q_b),
            color = "blue") +
  geom_line(aes(x = q_c),
            color = "green") +
  geom_line(aes(x = q_d),
            color = "yellow") +
  geom_line(aes(x = q_agg))
  
# Make a new aggregate cost curve and function

agg_abate_d <- lm(price ~ q_agg, data = agg_abate_d_df)

agg_abate_d

agg_abate_d_fx <- function(abatement){
  0.1423 * abatement - 5.0958
}

# And then use it to get the price. Note that the new total emissions is 600 tons

agg_abate_d_fx(600)

# Price of carbon is $80.2842 per ton

# How much will each sector produce?

# I want a quantity, given a price:

a_abatement_fx(80.2842)
# 153.2497

b_abatement_fx(80.2842)
# 182.394

c_abatement_fx(80.2842)
# 97.15645

sector_d_q_fx(80.2842)

# 167.1446


#####
# to double check...
# 153.2497 + 182.394 + 97.15645 + 167.1446 = 600!

# I can quantify the  benefit to Country Y (sector D):

# We know the price per ton of carbon is $80.2842
# And they're allotted 300 tons
# And we predict they'd produce 167.1446

##-------------
# I'm stuck here. What price does D sell its credits at??
##-------------

# I think its the area under the curve for D, or the area from abating zero units to the market efficient number of units (167 or whatever...)

# So the cost to them is...

80.2842 * (300-167.1446)

# They would make $10,666.19 selling carbon credits.


```

